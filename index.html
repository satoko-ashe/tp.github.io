<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能文本轮播播放器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* 现有样式保持不变 */
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            opacity: 1 !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #app-container {
            width: 1100px;
            max-width: 95vw;
            height: 750px;
            max-height: 90vh;
            background: var(--bg-surface);
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        /* 头部样式 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 i {
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .header-btn:hover {
            background: #f1f5f9;
            transform: translateY(-1px);
        }

        .header-btn.danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .header-btn.danger:hover {
            background: #dc2626;
        }

        /* 主要内容区域 */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow: hidden;
        }

        .current-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-file {
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: 12px;
            display: inline-block;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        /* 文本显示区域 */
        .text-display-container {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #text-scroll-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        #current-text {
            position: absolute;
            white-space: nowrap;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-primary);
            font-size: 2.2rem;
            font-weight: 600;
            padding: 0 24px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            transition: width 0.1s;
        }

        /* 控制区域 */
        .controls-container {
            position: relative;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            padding: 20px;
            background: var(--bg-surface);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: var(--bg-secondary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .control-btn.active {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(129, 140, 248, 0.1));
            color: var(--primary);
            border-color: var(--primary);
        }

        .play-btn {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            font-size: 28px;
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.25);
        }

        .play-btn:hover {
            box-shadow: 0 12px 25px rgba(79, 70, 229, 0.35);
            transform: translateY(-3px) scale(1.05);
        }

        /* 控制面板 - 从控制按钮下方弹出 */
        .control-panel {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: var(--bg-surface);
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            min-width: 200px;
            max-width: 250px;
        }

        .control-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .control-panel h3 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .panel-item {
            padding: 10px 14px;
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }

        .panel-item:hover {
            background: var(--bg-secondary);
        }

        /* 书架按钮样式 */
        .panel-item.book-shelf {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .panel-item.book-shelf:hover {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.2));
        }

        .panel-item.book-shelf i {
            color: #f59e0b;
        }

        /* 颜色选项 */
        .color-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        /* 模态窗口 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-surface);
            border-radius: 18px;
            padding: 24px;
            width: 600px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* 折叠面板样式 */
        .accordion-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .accordion-item {
            background: var(--bg-surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .accordion-header {
            padding: 16px 20px;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid transparent;
        }
        
        .accordion-header:hover {
            background: #f1f5f9;
        }
        
        .accordion-header.active {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(129, 140, 248, 0.05));
            border-bottom: 1px solid var(--primary);
        }
        
        .accordion-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }
        
        .accordion-icon {
            color: var(--primary);
            font-size: 16px;
        }
        
        .accordion-arrow {
            color: var(--text-secondary);
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        
        .accordion-arrow.active {
            transform: rotate(180deg);
            color: var(--primary);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background: var(--bg-surface);
        }
        
        .accordion-content.active {
            max-height: 1000px;
            padding: 20px;
        }
        
        .accordion-description {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 16px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }
        
        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .book-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .book-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .book-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(129, 140, 248, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 18px;
        }
        
        .book-card-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 15px;
        }
        
        .book-card-desc {
            font-size: 12px;
            color: var(--text-secondary);
            flex-grow: 1;
        }
        
        .book-action {
            margin-top: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .book-action:hover {
            background: #4338ca;
        }
        
        .add-book-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-book-card:hover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }
        
        .add-book-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            color: var(--success);
            font-size: 14px;
        }
        
        .add-book-text {
            font-weight: 500;
            color: var(--text-secondary);
            text-align: center;
            font-size: 13px;
        }
        
        .add-book-note {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 4px;
            font-style: italic;
        }

        /* 工具样式 */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .tool-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .tool-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .tool-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(129, 140, 248, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 18px;
        }
        
        .tool-card-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 15px;
        }
        
        .tool-card-desc {
            font-size: 12px;
            color: var(--text-secondary);
            flex-grow: 1;
            margin-bottom: 12px;
        }
        
        .tool-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
        }
        
        .tool-open-btn {
            flex: 1;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .tool-open-btn:hover {
            background: #4338ca;
        }
        
        .tool-delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tool-delete-btn:hover {
            background: #dc2626;
        }
        
        .tool-delete-btn.hidden {
            display: none;
        }
        
        .add-tool-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-tool-card:hover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }
        
        .add-tool-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            color: var(--success);
            font-size: 14px;
        }
        
        .add-tool-text {
            font-weight: 500;
            color: var(--text-secondary);
            text-align: center;
            font-size: 13px;
        }
        
        .add-tool-note {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 4px;
            font-style: italic;
        }

        /* 数据爬取模态窗口特定样式 */
        .crawl-section {
            margin-bottom: 20px;
        }

        .crawl-section h3 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .url-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .url-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .crawl-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .crawl-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.25);
        }

        .crawl-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .predefined-sources {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .source-btn {
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        .source-btn:hover {
            background: var(--bg-primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .source-btn i {
            margin-right: 8px;
            color: var(--primary);
        }

        .crawl-progress {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: none;
        }

        .crawl-progress.visible {
            display: block;
        }

        .progress-text {
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .progress-bar-container {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s;
        }

        .crawl-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .crawl-preview {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: none;
        }

        .crawl-preview.visible {
            display: block;
        }

        .preview-title {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .preview-content {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        .preview-content .sentence {
            margin-bottom: 5px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 6px;
        }

        /* 文件列表 */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .folder-item {
            margin: 10px 0;
        }

        .folder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
            transition: background 0.2s;
        }

        .folder-header:hover {
            background: #f1f5f9;
        }

        /* 文件夹删除按钮样式 */
        .folder-delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .folder-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .folder-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .folder-content {
            margin-left: 24px;
            margin-top: 8px;
            border-left: 2px dashed #cbd5e1;
            padding-left: 16px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            color: var(--text-primary);
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .file-item:hover {
            background: #f1f5f9;
            transform: translateX(3px);
        }

        .file-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .file-count {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .file-action {
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .file-action:hover {
            background: #4338ca;
        }

        .empty-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 30px 20px;
        }

        /* 速度选项 */
        .speed-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .speed-option {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            text-align: center;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .speed-option:hover {
            background: #f1f5f9;
        }

        .speed-option.active {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(129, 140, 248, 0.1));
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        /* 字体大小选项 */
        .font-size-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .font-size-option {
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .font-size-option:hover {
            background: #f1f5f9;
        }

        .font-size-option.active {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(129, 140, 248, 0.1));
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        /* 背景选项 */
        .background-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .background-option {
            height: 55px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .background-option:hover {
            transform: scale(1.05);
        }

        .background-option.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        /* 滑块 */
        .slider-container {
            margin-top: 20px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #4338ca;
            transform: scale(1.1);
        }

        /* 通知 */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 14px 18px;
            background: var(--bg-surface);
            border-radius: 12px;
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            animation: slideIn 0.3s, fadeOut 0.3s 2.7s;
            border-left: 4px solid var(--primary);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.success i {
            color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.error i {
            color: var(--danger);
        }

        .notification.info {
            border-left-color: var(--primary);
        }

        .notification.info i {
            color: var(--primary);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.warning i {
            color: var(--warning);
        }

        /* 图标模式 */
        .icon-mode {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 18px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .icon-mode.hidden {
            display: none;
        }

        .icon-mode:hover {
            transform: translateY(-3px) scale(1.05);
        }

        /* 隐藏的文件输入 */
        .file-input-wrapper {
            display: none;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            #app-container {
                width: 98vw;
                height: 98vh;
                max-height: 98vh;
                border-radius: 16px;
            }
            
            #current-text {
                font-size: 1.8rem;
            }
            
            .controls {
                gap: 12px;
            }
            
            .control-btn {
                width: 52px;
                height: 52px;
                font-size: 18px;
            }
            
            .play-btn {
                width: 70px;
                height: 70px;
                font-size: 24px;
            }
            
            .modal-content {
                width: 92vw;
                padding: 20px;
            }
            
            .speed-options {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .predefined-sources {
                grid-template-columns: 1fr;
            }
            
            .book-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .tools-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }
            
            .book-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 主应用容器 -->
    <div id="app-container">
        <div class="header">
            <h1><i class="fa fa-file-text-o"></i> 智能文本轮播播放器</h1>
            <div class="header-controls">
                <button id="window-toggle" class="header-btn">
                    <i class="fa fa-window-minimize"></i> 最小化
                </button>
                <button id="close-btn" class="header-btn danger">
                    <i class="fa fa-times"></i> 关闭
                </button>
            </div>
        </div>
        
        <div class="content">
            <div class="current-info">
                <div style="margin-bottom: 6px; color: var(--text-secondary); font-size: 14px;">当前播放</div>
                <div id="current-file-name" class="current-file">示例文本</div>
            </div>
            
            <div class="text-display-container">
                <div id="text-scroll-container">
                    <div id="current-text">欢迎使用智能文本轮播播放器</div>
                </div>
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            
            <div class="controls-container">
                <div class="controls">
                    <button id="play-btn" class="control-btn play-btn">
                        <i class="fa fa-play"></i>
                    </button>
                    
                    <button id="import-btn" class="control-btn" title="导入文本">
                        <i class="fa fa-upload"></i>
                    </button>
                    
                    <button id="speed-btn" class="control-btn" title="播放速度">
                        <i class="fa fa-tachometer"></i>
                    </button>
                    
                    <button id="text-select-btn" class="control-btn" title="选择文本">
                        <i class="fa fa-list"></i>
                    </button>
                    
                    <button id="color-btn" class="control-btn" title="文本颜色">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    
                    <button id="font-btn" class="control-btn" title="字体大小">
                        <i class="fa fa-font"></i>
                    </button>
                    
                    <button id="bg-btn" class="control-btn" title="背景设置">
                        <i class="fa fa-image"></i>
                    </button>
                    
                    <!-- 删除按钮 -->
                    <button id="delete-btn" class="control-btn" title="删除当前文本">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
                
                <!-- 导入面板 -->
                <div id="import-panel" class="control-panel">
                    <h3>导入文本</h3>
                    <div class="panel-item" id="import-file">
                        <i class="fa fa-file-text-o"></i>
                        <span>上传文件</span>
                    </div>
                    <div class="panel-item" id="import-folder">
                        <i class="fa fa-folder-open-o"></i>
                        <span>上传文件夹</span>
                    </div>
                    <!-- 书架功能 -->
                    <div class="panel-item book-shelf" id="book-shelf-btn">
                        <i class="fa fa-book"></i>
                        <span>书架</span>
                    </div>
                </div>
                
                <!-- 速度面板 -->
                <div id="speed-panel" class="control-panel">
                    <h3>播放速度</h3>
                    <div class="speed-options">
                        <div class="speed-option active" data-speed="0.5">0.5x</div>
                        <div class="speed-option" data-speed="1">1x</div>
                        <div class="speed-option" data-speed="1.5">1.5x</div>
                        <div class="speed-option" data-speed="2">2x</div>
                    </div>
                </div>
                
                <!-- 颜色面板 -->
                <div id="color-panel" class="control-panel">
                    <h3>文本颜色</h3>
                    <div class="color-options">
                        <div class="color-option active" style="background: #1e293b;" data-color="#1e293b"></div>
                        <div class="color-option" style="background: #0f766e;" data-color="#0f766e"></div>
                        <div class="color-option" style="background: #1e40af;" data-color="#1e40af"></div>
                        <div class="color-option" style="background: #7c2d12;" data-color="#7c2d12"></div>
                        <div class="color-option" style="background: #7b3fe4;" data-color="#7b3fe4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 图标模式 -->
    <div id="icon-mode" class="icon-mode hidden">
        <i class="fa fa-file-text-o"></i>
    </div>
    
    <!-- 模态窗口：文件列表 -->
    <div id="file-list-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa fa-list"></i> 选择播放文本</h2>
                <button class="modal-close-btn" id="close-file-list-modal">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="file-list-container" class="file-list">
                <!-- 文件列表将动态生成 -->
            </div>
            <div id="no-files-message" class="empty-message">
                <i class="fa fa-folder-open-o" style="font-size: 48px; margin-bottom: 12px; color: #cbd5e1;"></i>
                <p>暂无文本文件</p>
                <p style="font-size: 14px; margin-top: 6px;">点击导入按钮添加文本文件</p>
            </div>
        </div>
    </div>
    
    <!-- 模态窗口：字体大小 -->
    <div id="font-size-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa fa-font"></i> 字体大小</h2>
                <button class="modal-close-btn" id="close-font-size-modal">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="font-size-options">
                <div class="font-size-option" data-size="small">
                    <div style="font-weight: 600; margin-bottom: 4px;">小号字体</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">适合快速阅读</div>
                </div>
                <div class="font-size-option active" data-size="medium">
                    <div style="font-weight: 600; margin-bottom: 4px;">中号字体</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">标准大小</div>
                </div>
                <div class="font-size-option" data-size="large">
                    <div style="font-weight: 600; margin-bottom: 4px;">大号字体</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">适合远距离观看</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 模态窗口：背景设置 -->
    <div id="background-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa fa-image"></i> 背景设置</h2>
                <button class="modal-close-btn" id="close-background-modal">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div>
                <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 15px;">背景颜色</h3>
                <div class="background-options">
                    <div class="background-option active" style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);" data-bg="default"></div>
                    <div class="background-option" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);" data-bg="blue"></div>
                    <div class="background-option" style="background: linear-gradient(135deg, #f0abfc 0%, #c77dff 100%);" data-bg="purple"></div>
                    <div class="background-option" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);" data-bg="green"></div>
                    <div class="background-option" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);" data-bg="red"></div>
                    <div class="background-option" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%);" data-bg="dark"></div>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>背景透明度</span>
                        <span id="opacity-value">100%</span>
                    </div>
                    <input type="range" id="background-opacity" min="0.1" max="1" step="0.1" value="1" class="slider">
                </div>
            </div>
        </div>
    </div>
    
    <!-- 模态窗口：数据爬取 -->
    <div id="crawl-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa fa-cloud-download"></i> 智能数据爬取</h2>
                <button class="modal-close-btn" id="close-crawl-modal">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="crawl-section">
                <h3>1. 输入网址爬取</h3>
                <div class="url-input-group">
                    <input type="text" id="crawl-url" class="url-input" placeholder="输入要爬取的网址 (例如: https://example.com)" value="">
                    <button id="start-crawl-btn" class="crawl-btn">
                        <i class="fa fa-download"></i> 开始爬取
                    </button>
                </div>
            </div>
            
            <div class="crawl-section">
                <h3>2. 或选择预设数据源</h3>
                <div class="predefined-sources">
                    <button class="source-btn" data-source="news">
                        <i class="fa fa-newspaper-o"></i> 新闻资讯
                    </button>
                    <button class="source-btn" data-source="quotes">
                        <i class="fa fa-quote-right"></i> 名人名言
                    </button>
                    <button class="source-btn" data-source="poetry">
                        <i class="fa fa-book"></i> 诗词歌赋
                    </button>
                    <button class="source-btn" data-source="jokes">
                        <i class="fa fa-smile-o"></i> 笑话段子
                    </button>
                    <button class="source-btn" data-source="knowledge">
                        <i class="fa fa-lightbulb-o"></i> 知识科普
                    </button>
                    <button class="source-btn" data-source="custom">
                        <i class="fa fa-cogs"></i> 自定义API
                    </button>
                </div>
            </div>
            
            <div id="crawl-progress" class="crawl-progress">
                <div class="progress-text">
                    <span id="progress-status">正在爬取数据...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div class="crawl-stats">
                    <span>已获取: <span id="crawl-count">0</span> 条文本</span>
                    <span>预计剩余: <span id="time-remaining">--</span> 秒</span>
                </div>
            </div>
            
            <div id="crawl-preview" class="crawl-preview">
                <div class="preview-title">爬取预览</div>
                <div id="preview-content" class="preview-content">
                    <!-- 预览内容将动态生成 -->
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancel-crawl-btn" class="header-btn">
                    <i class="fa fa-times"></i> 取消
                </button>
                <button id="save-crawl-btn" class="header-btn" style="background: var(--success); color: white; border-color: var(--success);">
                    <i class="fa fa-save"></i> 保存到播放列表
                </button>
            </div>
        </div>
    </div>
    
    <!-- 模态窗口：书架 - 折叠面板优化 -->
    <div id="book-shelf-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa fa-book"></i> 书架管理</h2>
                <button class="modal-close-btn" id="close-book-shelf-modal">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 折叠面板容器 -->
            <div class="accordion-container">
                <!-- 我的书城面板 -->
                <div class="accordion-item" id="book-city-accordion">
                    <div class="accordion-header active" data-target="book-city-content">
                        <div class="accordion-title">
                            <i class="fa fa-book accordion-icon"></i>
                            <span>我的书城</span>
                        </div>
                        <i class="fa fa-chevron-down accordion-arrow active"></i>
                    </div>
                    <div class="accordion-content active" id="book-city-content">
                        <div class="accordion-description">在线阅读网站，随时随地畅享阅读</div>
                        <div class="book-grid" id="book-city-grid">
                            <!-- 我的书城书籍将动态生成 -->
                        </div>
                        
                        <!-- 添加自定义书籍卡片 -->
                        <div class="add-book-card" id="add-book-city-card">
                            <div class="add-book-icon">
                                <i class="fa fa-plus"></i>
                            </div>
                            <div class="add-book-text">添加自定义</div>
                            <div class="add-book-note">数据不同步仅存本机</div>
                        </div>
                    </div>
                </div>
                
                <!-- 推荐书本面板 -->
                <div class="accordion-item" id="recommended-accordion">
                    <div class="accordion-header" data-target="recommended-content">
                        <div class="accordion-title">
                            <i class="fa fa-star accordion-icon"></i>
                            <span>推荐书本</span>
                        </div>
                        <i class="fa fa-chevron-down accordion-arrow"></i>
                    </div>
                    <div class="accordion-content" id="recommended-content">
                        <div class="accordion-description">精选推荐，优质资源一键直达</div>
                        <div class="book-grid" id="recommended-grid">
                            <!-- 推荐书籍将动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 我的收藏面板 -->
                <div class="accordion-item" id="collection-accordion">
                    <div class="accordion-header" data-target="collection-content">
                        <div class="accordion-title">
                            <i class="fa fa-heart accordion-icon"></i>
                            <span>我的收藏</span>
                        </div>
                        <i class="fa fa-chevron-down accordion-arrow"></i>
                    </div>
                    <div class="accordion-content" id="collection-content">
                        <div class="accordion-description">个人收藏，便捷访问常用资源</div>
                        <div class="book-grid" id="collection-grid">
                            <!-- 收藏书籍将动态生成 -->
                        </div>
                        
                        <!-- 添加自定义收藏卡片 -->
                        <div class="add-book-card" id="add-collection-card">
                            <div class="add-book-icon">
                                <i class="fa fa-plus"></i>
                            </div>
                            <div class="add-book-text">添加自定义</div>
                            <div class="add-book-note">数据不同步仅存本机</div>
                        </div>
                    </div>
                </div>
                
                <!-- 实用工具面板 -->
                <div class="accordion-item" id="tools-accordion">
                    <div class="accordion-header" data-target="tools-content">
                        <div class="accordion-title">
                            <i class="fa fa-wrench accordion-icon"></i>
                            <span>实用工具</span>
                        </div>
                        <i class="fa fa-chevron-down accordion-arrow"></i>
                    </div>
                    <div class="accordion-content" id="tools-content">
                        <div class="accordion-description">常用工具，便捷访问（自定义工具仅保存在本机）</div>
                        <div class="tools-grid" id="tools-grid">
                            <!-- 工具将动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 文件输入 -->
    <input type="file" id="file-input" class="file-input-wrapper" accept=".txt,.text" multiple>
    <input type="file" id="folder-input" class="file-input-wrapper" webkitdirectory directory multiple>
    
    <!-- 通知区域 -->
    <div id="notification-area"></div>
    
    <script>
        class TextCarousel {
            constructor() {
                this.isPlaying = false;
                this.currentSpeed = 1;
                this.currentTextIndex = 0;
                this.textColor = '#1e293b';
                this.texts = [];
                this.fontSize = 'medium';
                this.animationId = null;
                this.currentPosition = 0;
                this.baseSpeed = 2;
                this.backgroundPreset = 'default';
                this.backgroundOpacity = 1;
                this.currentPanel = null;
                this.currentFolder = null;
                this.isCrawling = false;
                this.crawledData = [];
                
                // 书架数据
                this.books = {
                    bookCity: [],    // 我的书城
                    recommended: [], // 推荐书本
                    collection: []   // 我的收藏
                };
                
                // 工具数据
                this.tools = [];
                
                // 初始化
                this.init();
            }

            init() {
                this.bindElements();
                this.bindEvents();
                this.loadFromStorage();
                this.addExampleTexts();
                this.loadDefaultBooks(); // 加载默认书籍
                this.loadDefaultTools(); // 加载默认工具
                this.renderBookPanels(); // 渲染书架面板
                this.renderToolsGrid();  // 渲染工具网格
                this.updateUI();
                this.displayCurrentText();
                this.initAccordions();   // 初始化折叠面板
            }

            bindElements() {
                // 主容器
                this.appContainer = document.getElementById('app-container');
                this.iconMode = document.getElementById('icon-mode');
                
                // 窗口控制
                this.windowToggleBtn = document.getElementById('window-toggle');
                this.closeBtn = document.getElementById('close-btn');
                
                // 播放控制
                this.playBtn = document.getElementById('play-btn');
                this.textElement = document.getElementById('current-text');
                this.scrollContainer = document.getElementById('text-scroll-container');
                this.progressBar = document.getElementById('progress-bar');
                this.currentFileName = document.getElementById('current-file-name');
                
                // 控制按钮
                this.importBtn = document.getElementById('import-btn');
                this.speedBtn = document.getElementById('speed-btn');
                this.textSelectBtn = document.getElementById('text-select-btn');
                this.colorBtn = document.getElementById('color-btn');
                this.fontBtn = document.getElementById('font-btn');
                this.bgBtn = document.getElementById('bg-btn');
                this.deleteBtn = document.getElementById('delete-btn');
                
                // 控制面板
                this.importPanel = document.getElementById('import-panel');
                this.speedPanel = document.getElementById('speed-panel');
                this.colorPanel = document.getElementById('color-panel');
                
                // 模态窗口
                this.fileListModal = document.getElementById('file-list-modal');
                this.fontSizeModal = document.getElementById('font-size-modal');
                this.backgroundModal = document.getElementById('background-modal');
                this.crawlModal = document.getElementById('crawl-modal');
                this.bookShelfModal = document.getElementById('book-shelf-modal');
                
                // 文件列表
                this.fileListContainer = document.getElementById('file-list-container');
                this.noFilesMessage = document.getElementById('no-files-message');
                
                // 书架相关元素
                this.bookCityGrid = document.getElementById('book-city-grid');
                this.recommendedGrid = document.getElementById('recommended-grid');
                this.collectionGrid = document.getElementById('collection-grid');
                this.addBookCityCard = document.getElementById('add-book-city-card');
                this.addCollectionCard = document.getElementById('add-collection-card');
                
                // 折叠面板相关元素
                this.accordionHeaders = document.querySelectorAll('.accordion-header');
                this.accordionContents = document.querySelectorAll('.accordion-content');
                
                // 工具相关元素
                this.toolsGrid = document.getElementById('tools-grid');
                
                // 关闭按钮
                this.closeFileListModalBtn = document.getElementById('close-file-list-modal');
                this.closeFontSizeModalBtn = document.getElementById('close-font-size-modal');
                this.closeBackgroundModalBtn = document.getElementById('close-background-modal');
                this.closeCrawlModalBtn = document.getElementById('close-crawl-modal');
                this.closeBookShelfModalBtn = document.getElementById('close-book-shelf-modal');
                
                // 文件输入
                this.fileInput = document.getElementById('file-input');
                this.folderInput = document.getElementById('folder-input');
                
                // 导入面板按钮
                this.importFileBtn = document.getElementById('import-file');
                this.importFolderBtn = document.getElementById('import-folder');
                this.bookShelfBtn = document.getElementById('book-shelf-btn');
                
                // 背景设置
                this.backgroundOpacityInput = document.getElementById('background-opacity');
                this.opacityValue = document.getElementById('opacity-value');
                
                // 数据爬取相关元素
                this.crawlUrlInput = document.getElementById('crawl-url');
                this.startCrawlBtn = document.getElementById('start-crawl-btn');
                this.cancelCrawlBtn = document.getElementById('cancel-crawl-btn');
                this.saveCrawlBtn = document.getElementById('save-crawl-btn');
                this.crawlProgress = document.getElementById('crawl-progress');
                this.crawlPreview = document.getElementById('crawl-preview');
                this.progressFill = document.getElementById('progress-fill');
                this.progressStatus = document.getElementById('progress-status');
                this.progressPercent = document.getElementById('progress-percent');
                this.crawlCount = document.getElementById('crawl-count');
                this.timeRemaining = document.getElementById('time-remaining');
                this.previewContent = document.getElementById('preview-content');
                
                // 预设数据源按钮
                this.sourceButtons = document.querySelectorAll('.source-btn');
                
                // 通知区域
                this.notificationArea = document.getElementById('notification-area');
            }

            bindEvents() {
                // 窗口控制
                this.windowToggleBtn.addEventListener('click', () => this.toggleWindowMode());
                this.closeBtn.addEventListener('click', () => this.closeApp());
                this.iconMode.addEventListener('click', () => this.toggleWindowMode());
                
                // 播放控制
                this.playBtn.addEventListener('click', () => this.togglePlayPause());
                
                // 文本双击切换颜色
                this.textElement.addEventListener('dblclick', () => {
                    this.togglePanel(this.colorPanel);
                });
                
                // 控制按钮点击事件
                this.importBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.togglePanel(this.importPanel);
                });
                
                this.speedBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.togglePanel(this.speedPanel);
                });
                
                this.textSelectBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showFileListModal();
                    this.hideAllPanels();
                });
                
                this.colorBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.togglePanel(this.colorPanel);
                });
                
                this.fontBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showFontSizeModal();
                    this.hideAllPanels();
                });
                
                this.bgBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showBackgroundModal();
                    this.hideAllPanels();
                });
                
                this.deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deleteCurrentText();
                    this.hideAllPanels();
                });
                
                // 导入面板
                this.importFileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.fileInput.click();
                    this.hideAllPanels();
                });
                
                this.importFolderBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.folderInput.click();
                    this.hideAllPanels();
                });
                
                // 书架按钮
                this.bookShelfBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showBookShelfModal();
                    this.hideAllPanels();
                });
                
                // 文件输入事件
                this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.folderInput.addEventListener('change', (e) => this.handleFolderUpload(e));
                
                // 速度选择
                document.querySelectorAll('.speed-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const speed = parseFloat(option.dataset.speed);
                        this.setSpeed(speed);
                        this.hideAllPanels();
                    });
                });
                
                // 颜色选择
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const color = option.dataset.color;
                        this.setTextColor(color);
                        this.hideAllPanels();
                    });
                });
                
                // 字体大小选择
                document.querySelectorAll('.font-size-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const size = option.dataset.size;
                        this.setFontSize(size);
                        this.hideFontSizeModal();
                    });
                });
                
                // 背景选择
                document.querySelectorAll('.background-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const bg = option.dataset.bg;
                        this.setBackgroundColor(bg);
                    });
                });
                
                // 背景透明度
                this.backgroundOpacityInput.addEventListener('input', (e) => {
                    this.setBackgroundOpacity(parseFloat(e.target.value));
                });
                
                // 我的书城自定义添加
                this.addBookCityCard.addEventListener('click', () => {
                    this.addCustomBook('bookCity');
                });
                
                // 我的收藏自定义添加
                this.addCollectionCard.addEventListener('click', () => {
                    this.addCustomBook('collection');
                });
                
                // 关闭模态窗口
                this.closeFileListModalBtn.addEventListener('click', () => this.hideFileListModal());
                this.closeFontSizeModalBtn.addEventListener('click', () => this.hideFontSizeModal());
                this.closeBackgroundModalBtn.addEventListener('click', () => this.hideBackgroundModal());
                this.closeCrawlModalBtn.addEventListener('click', () => this.hideCrawlModal());
                this.cancelCrawlBtn.addEventListener('click', () => this.hideCrawlModal());
                this.closeBookShelfModalBtn.addEventListener('click', () => this.hideBookShelfModal());
                
                // 数据爬取事件
                this.startCrawlBtn.addEventListener('click', () => this.startCrawling());
                this.saveCrawlBtn.addEventListener('click', () => this.saveCrawledData());
                this.crawlUrlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.startCrawling();
                    }
                });
                
                // 预设数据源按钮
                this.sourceButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const source = e.currentTarget.dataset.source;
                        this.loadPredefinedSource(source);
                    });
                });
                
                // 点击外部关闭面板
                document.addEventListener('click', (e) => {
                    if (this.currentPanel && !this.currentPanel.contains(e.target)) {
                        this.hideAllPanels();
                    }
                });
                
                // 点击模态窗口背景关闭
                this.fileListModal.addEventListener('click', (e) => {
                    if (e.target === this.fileListModal) this.hideFileListModal();
                });
                
                this.fontSizeModal.addEventListener('click', (e) => {
                    if (e.target === this.fontSizeModal) this.hideFontSizeModal();
                });
                
                this.backgroundModal.addEventListener('click', (e) => {
                    if (e.target === this.backgroundModal) this.hideBackgroundModal();
                });
                
                this.crawlModal.addEventListener('click', (e) => {
                    if (e.target === this.crawlModal) this.hideCrawlModal();
                });
                
                this.bookShelfModal.addEventListener('click', (e) => {
                    if (e.target === this.bookShelfModal) this.hideBookShelfModal();
                });
            }
            
            // 初始化折叠面板
            initAccordions() {
                this.accordionHeaders.forEach(header => {
                    header.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const targetId = header.dataset.target;
                        const content = document.getElementById(targetId);
                        const arrow = header.querySelector('.accordion-arrow');
                        
                        // 切换当前面板
                        if (content.classList.contains('active')) {
                            // 如果已经展开，则关闭
                            content.classList.remove('active');
                            header.classList.remove('active');
                            arrow.classList.remove('active');
                        } else {
                            // 如果未展开，则展开并关闭其他面板
                            this.accordionContents.forEach(c => {
                                c.classList.remove('active');
                            });
                            this.accordionHeaders.forEach(h => {
                                h.classList.remove('active');
                                h.querySelector('.accordion-arrow').classList.remove('active');
                            });
                            
                            // 展开当前面板
                            content.classList.add('active');
                            header.classList.add('active');
                            arrow.classList.add('active');
                        }
                    });
                });
            }
            
            // 添加自定义书籍（简化版）
            addCustomBook(panelType) {
                const name = prompt('请输入网站名称：');
                if (!name) return;
                
                const url = prompt('请输入网站链接：');
                if (!url) return;
                
                // 验证URL格式
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    this.showNotification('请输入有效的链接地址（以http://或https://开头）', 'warning');
                    return;
                }
                
                const book = {
                    id: 'custom-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    name: name,
                    url: url,
                    desc: '自定义添加',
                    added: new Date().getTime(),
                    isCustom: true
                };
                
                // 添加到对应的面板
                this.books[panelType].push(book);
                this.saveBooksToStorage();
                this.renderBookPanels();
                
                this.showNotification(`已添加: ${name}`, 'success');
            }
            
            // 加载默认工具
            loadDefaultTools() {
                const defaultTools = [
                    {
                        id: 'tool-wps',
                        name: 'WPS便签',
                        url: 'https://note.wps.cn/',
                        desc: '便捷的在线笔记工具',
                        icon: 'fa-sticky-note',
                        isCustom: false
                    },
                    {
                        id: 'tool-chapter',
                        name: '章节切割器',
                        url: 'https://www.shuidi365.cn/tools/txtChapterSplit/',
                        desc: '文本章节分割工具',
                        icon: 'fa-scissors',
                        isCustom: false
                    },
                    {
                        id: 'tool-crawl',
                        name: '一键爬取数据',
                        url: '#',
                        desc: '智能数据爬取功能',
                        icon: 'fa-cloud-download',
                        isCustom: false,
                        action: 'crawl' // 特殊标记，表示点击时执行功能而非打开链接
                    }
                ];
                
                // 检查本地存储中是否已有工具数据
                const savedTools = localStorage.getItem('textCarouselTools');
                if (!savedTools) {
                    this.tools = defaultTools;
                    this.saveToolsToStorage();
                } else {
                    this.loadToolsFromStorage();
                    // 确保默认工具存在
                    defaultTools.forEach(defaultTool => {
                        if (!this.tools.find(tool => tool.id === defaultTool.id)) {
                            this.tools.push(defaultTool);
                        }
                    });
                    this.saveToolsToStorage();
                }
            }
            
            // 渲染工具网格
            renderToolsGrid() {
                this.toolsGrid.innerHTML = '';
                
                this.tools.forEach(tool => {
                    const toolCard = document.createElement('div');
                    toolCard.className = 'tool-card';
                    
                    toolCard.innerHTML = `
                        <div class="tool-icon">
                            <i class="fa ${tool.icon || 'fa-wrench'}"></i>
                        </div>
                        <div class="tool-card-name">${tool.name}</div>
                        <div class="tool-card-desc">${tool.desc || ''}</div>
                        <div class="tool-actions">
                            <button class="tool-open-btn" data-tool-id="${tool.id}">打开</button>
                            ${tool.isCustom ? '<button class="tool-delete-btn" data-tool-id="' + tool.id + '">删除</button>' : '<button class="tool-delete-btn hidden" data-tool-id="' + tool.id + '">删除</button>'}
                        </div>
                    `;
                    
                    this.toolsGrid.appendChild(toolCard);
                });
                
                // 添加工具卡片
                const addToolCard = document.createElement('div');
                addToolCard.className = 'add-tool-card';
                addToolCard.innerHTML = `
                    <div class="add-tool-icon">
                        <i class="fa fa-plus"></i>
                    </div>
                    <div class="add-tool-text">添加自定义工具</div>
                    <div class="add-tool-note">数据不同步仅存本机</div>
                `;
                
                addToolCard.addEventListener('click', () => {
                    this.addCustomTool();
                });
                
                this.toolsGrid.appendChild(addToolCard);
                
                // 绑定工具按钮事件
                this.bindToolEvents();
            }
            
            // 绑定工具按钮事件
            bindToolEvents() {
                // 绑定打开按钮事件
                document.querySelectorAll('.tool-open-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const toolId = e.currentTarget.dataset.toolId;
                        const tool = this.tools.find(t => t.id === toolId);
                        
                        if (tool) {
                            if (tool.action === 'crawl') {
                                // 如果是爬取功能，显示爬取模态窗口
                                this.showCrawlModal();
                                this.hideBookShelfModal();
                            } else {
                                // 否则打开链接
                                window.open(tool.url, '_blank');
                                this.showNotification(`正在打开: ${tool.name}`, 'info');
                            }
                        }
                    });
                });
                
                // 绑定删除按钮事件
                document.querySelectorAll('.tool-delete-btn:not(.hidden)').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const toolId = e.currentTarget.dataset.toolId;
                        this.deleteCustomTool(toolId);
                    });
                });
            }
            
            // 添加自定义工具
            addCustomTool() {
                const name = prompt('请输入工具名称：');
                if (!name) return;
                
                const url = prompt('请输入工具链接（输入#留空则不打开链接）：');
                if (!url) return;
                
                const desc = prompt('请输入工具描述：') || '';
                
                // 验证URL格式（如果提供了URL且不是#）
                if (url !== '#' && !url.startsWith('http://') && !url.startsWith('https://')) {
                    this.showNotification('请输入有效的链接地址（以http://或https://开头），或输入#留空', 'warning');
                    return;
                }
                
                const tool = {
                    id: 'tool-custom-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    name: name,
                    url: url,
                    desc: desc,
                    icon: 'fa-external-link',
                    isCustom: true
                };
                
                // 添加到工具列表
                this.tools.push(tool);
                this.saveToolsToStorage();
                this.renderToolsGrid();
                
                this.showNotification(`已添加工具: ${name}`, 'success');
            }
            
            // 删除自定义工具
            deleteCustomTool(toolId) {
                const tool = this.tools.find(t => t.id === toolId);
                
                if (!tool) {
                    this.showNotification('未找到该工具', 'error');
                    return;
                }
                
                if (!tool.isCustom) {
                    this.showNotification('默认工具不可删除', 'warning');
                    return;
                }
                
                if (confirm(`确定要删除工具 "${tool.name}" 吗？`)) {
                    const index = this.tools.findIndex(t => t.id === toolId);
                    if (index !== -1) {
                        this.tools.splice(index, 1);
                        this.saveToolsToStorage();
                        this.renderToolsGrid();
                        this.showNotification(`已删除工具: ${tool.name}`, 'success');
                    }
                }
            }
            
            // 保存工具数据到本地存储
            saveToolsToStorage() {
                try {
                    localStorage.setItem('textCarouselTools', JSON.stringify(this.tools));
                } catch (e) {
                    console.error('保存工具数据失败:', e);
                    this.showNotification('保存工具数据失败', 'error');
                }
            }
            
            // 从本地存储加载工具数据
            loadToolsFromStorage() {
                try {
                    const data = localStorage.getItem('textCarouselTools');
                    if (data) {
                        const parsed = JSON.parse(data);
                        this.tools = parsed || [];
                    }
                } catch (e) {
                    console.error('加载工具数据失败:', e);
                    this.showNotification('加载工具数据失败', 'error');
                }
            }
            
            // 加载默认书籍 - 修复版
            loadDefaultBooks() {
                // 我的书城 - 按照要求更新
                const defaultBookCity = [
                    {
                        id: 'book-city-1',
                        name: 'txt小说网',
                        url: 'https://txtxiaoshuo.com/',
                        icon: 'fa-book',
                        desc: '海量小说在线阅读',
                        added: new Date().getTime(),
                        isCustom: false
                    },
                    {
                        id: 'book-city-2',
                        name: 'Z-library（世界第一电子书网）',
                        url: 'https://zh.cub101.ru/',
                        icon: 'fa-globe',
                        desc: '全球最大电子书库',
                        added: new Date().getTime(),
                        isCustom: false
                    },
                    {
                        id: 'book-city-3',
                        name: '新书包网',
                        url: 'https://www.xbookbao.net/',
                        icon: 'fa-book',
                        desc: '热门小说资源',
                        added: new Date().getTime(),
                        isCustom: false
                    },
                    {
                        id: 'book-city-4',
                        name: '笔趣阁',
                        url: 'http://zhtjx.com/',
                        icon: 'fa-book',
                        desc: '经典小说阅读',
                        added: new Date().getTime(),
                        isCustom: false
                    }
                ];
                
                // 推荐书本 - 按照要求更新
                const defaultRecommended = [
                    {
                        id: 'recommended-1',
                        name: '魔道祖师下载密码：2025',
                        url: 'https://wwbpm.lanzoue.com/b00l2hafsf',
                        icon: 'fa-download',
                        desc: '热门小说资源',
                        added: new Date().getTime(),
                        isCustom: false
                    },
                    {
                        id: 'recommended-2',
                        name: '考研单词下载密码：2025',
                        url: 'https://wwbpm.lanzoue.com/b00l2hafre',
                        icon: 'fa-download',
                        desc: '学习资料',
                        added: new Date().getTime(),
                        isCustom: false
                    },
                    {
                        id: 'recommended-3',
                        name: '推荐书本更新中下载密码：2025',
                        url: 'https://wwbpm.lanzoue.com/b00l2hbi1c',
                        icon: 'fa-refresh',
                        desc: '持续更新中',
                        added: new Date().getTime(),
                        isCustom: false
                    },
                    {
                        id: 'recommended-4',
                        name: '文本轮播器使用说明书',
                        url: 'http://photogzmaz.photo.store.qq.com/psc?/V52Q8F7n4RatXA22tZ1W0xsVfm36uxdb/TmEUgtj9EK6.7V8ajmQrECnvVtOdH0cayf3QZTQPoixxIt39eNKkKvAqrbe7e7lz1CsaPXUrMmY6k9rlLpy7EMMo*j5qTcdXiwUJ2MJ6LD4!/b&bo=MAPmBTAD5gUDJwI!&rf=viewer_4&t=5',
                        icon: 'fa-file-text',
                        desc: '使用说明文档',
                        added: new Date().getTime(),
                        isCustom: false
                    }
                ];
                
                // 我的收藏 - 按照要求更新
                const defaultCollection = [
                    {
                        id: 'collection-1',
                        name: '蓝奏云盘',
                        url: 'https://pc.woozooo.com/',
                        icon: 'fa-cloud',
                        desc: '文件存储分享',
                        added: new Date().getTime(),
                        isCustom: false
                    },
                    {
                        id: 'collection-2',
                        name: '百度云盘',
                        url: 'https://pan.baidu.com/disk/main#/index?category=all',
                        icon: 'fa-cloud',
                        desc: '云端存储服务',
                        added: new Date().getTime(),
                        isCustom: false
                    },
                    {
                        id: 'collection-3',
                        name: '夸克网盘',
                        url: 'https://pan.quark.cn/',
                        icon: 'fa-cloud',
                        desc: '智能云存储',
                        added: new Date().getTime(),
                        isCustom: false
                    },
                    {
                        id: 'collection-4',
                        name: '阿里云盘',
                        url: 'https://www.alipan.com/sign/in?',
                        icon: 'fa-cloud',
                        desc: '高速云存储',
                        added: new Date().getTime(),
                        isCustom: false
                    }
                ];
                
                // 检查本地存储中是否已有数据
                const savedData = localStorage.getItem('textCarouselBooks');
                if (!savedData) {
                    // 如果没有保存的数据，使用默认数据
                    this.books = {
                        bookCity: defaultBookCity,
                        recommended: defaultRecommended,
                        collection: defaultCollection
                    };
                    this.saveBooksToStorage();
                } else {
                    // 如果有保存的数据，则加载它
                    try {
                        const parsed = JSON.parse(savedData);
                        // 确保每个面板都有默认数据
                        this.books = {
                            bookCity: this.mergeBooks(parsed.bookCity || [], defaultBookCity),
                            recommended: this.mergeBooks(parsed.recommended || [], defaultRecommended),
                            collection: this.mergeBooks(parsed.collection || [], defaultCollection)
                        };
                        this.saveBooksToStorage();
                    } catch (e) {
                        console.error('解析保存的书架数据失败，使用默认数据', e);
                        this.books = {
                            bookCity: defaultBookCity,
                            recommended: defaultRecommended,
                            collection: defaultCollection
                        };
                        this.saveBooksToStorage();
                    }
                }
            }
            
            // 合并书籍数据，确保默认书籍存在
            mergeBooks(savedBooks, defaultBooks) {
                // 创建一个映射来存储书籍
                const bookMap = new Map();
                
                // 首先添加所有默认书籍
                defaultBooks.forEach(book => {
                    bookMap.set(book.id, book);
                });
                
                // 然后添加保存的书籍（覆盖默认书籍，如果存在）
                savedBooks.forEach(book => {
                    // 如果保存的书籍有isCustom标记，保留它
                    if (book.isCustom) {
                        bookMap.set(book.id, book);
                    } else {
                        // 对于非自定义书籍，如果默认书籍中已有，则保留默认的
                        if (!bookMap.has(book.id)) {
                            bookMap.set(book.id, book);
                        }
                    }
                });
                
                // 转换为数组并返回
                return Array.from(bookMap.values());
            }
            
            // 渲染书架面板
            renderBookPanels() {
                // 渲染我的书城
                this.renderBookGrid(this.bookCityGrid, this.books.bookCity, 'bookCity');
                
                // 渲染推荐书本
                this.renderBookGrid(this.recommendedGrid, this.books.recommended, 'recommended');
                
                // 渲染我的收藏
                this.renderBookGrid(this.collectionGrid, this.books.collection, 'collection');
            }
            
            // 渲染书籍网格
            renderBookGrid(gridElement, books, panelType) {
                gridElement.innerHTML = '';
                
                books.forEach(book => {
                    const bookCard = document.createElement('div');
                    bookCard.className = 'book-card';
                    
                    let iconClass = book.icon || 'fa-external-link';
                    
                    bookCard.innerHTML = `
                        <div class="book-icon">
                            <i class="fa ${iconClass}"></i>
                        </div>
                        <div class="book-card-name">${book.name}</div>
                        <div class="book-card-desc">${book.desc || ''}</div>
                        <button class="book-action">打开</button>
                    `;
                    
                    // 添加打开链接事件
                    const openBtn = bookCard.querySelector('.book-action');
                    openBtn.addEventListener('click', () => {
                        window.open(book.url, '_blank');
                        this.showNotification(`正在打开: ${book.name}`, 'info');
                    });
                    
                    // 如果是自定义书籍，添加删除按钮
                    if (book.isCustom) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'book-action';
                        deleteBtn.style.background = 'var(--danger)';
                        deleteBtn.style.marginTop = '8px';
                        deleteBtn.textContent = '删除';
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm(`确定要删除 "${book.name}" 吗？`)) {
                                const index = this.books[panelType].findIndex(b => b.id === book.id);
                                if (index !== -1) {
                                    this.books[panelType].splice(index, 1);
                                    this.saveBooksToStorage();
                                    this.renderBookPanels();
                                    this.showNotification(`已删除: ${book.name}`, 'success');
                                }
                            }
                        });
                        bookCard.appendChild(deleteBtn);
                    }
                    
                    gridElement.appendChild(bookCard);
                });
            }
            
            // 保存书架数据到本地存储
            saveBooksToStorage() {
                try {
                    localStorage.setItem('textCarouselBooks', JSON.stringify(this.books));
                } catch (e) {
                    console.error('保存书架数据失败:', e);
                    this.showNotification('保存书架数据失败', 'error');
                }
            }
            
            // 从本地存储加载书架数据
            loadBooksFromStorage() {
                try {
                    const data = localStorage.getItem('textCarouselBooks');
                    if (data) {
                        const parsed = JSON.parse(data);
                        if (parsed.bookCity) this.books.bookCity = parsed.bookCity;
                        if (parsed.recommended) this.books.recommended = parsed.recommended;
                        if (parsed.collection) this.books.collection = parsed.collection;
                    }
                } catch (e) {
                    console.error('加载书架数据失败:', e);
                    this.showNotification('加载书架数据失败', 'error');
                }
            }
            
            // 切换面板显示/隐藏
            togglePanel(panel) {
                if (this.currentPanel === panel && panel.classList.contains('active')) {
                    this.hideAllPanels();
                } else {
                    this.hideAllPanels();
                    panel.classList.add('active');
                    this.currentPanel = panel;
                }
            }
            
            // 隐藏所有面板
            hideAllPanels() {
                document.querySelectorAll('.control-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                this.currentPanel = null;
            }

            // 切换窗口/图标模式
            toggleWindowMode() {
                if (this.appContainer.style.display !== 'none') {
                    this.appContainer.style.display = 'none';
                    this.iconMode.classList.remove('hidden');
                    this.pause();
                } else {
                    this.appContainer.style.display = 'flex';
                    this.iconMode.classList.add('hidden');
                }
                this.saveToStorage();
            }

            // 关闭应用
            closeApp() {
                if (confirm('确定要关闭文本轮播播放器吗？')) {
                    window.close();
                }
            }

            // 播放/暂停切换
            togglePlayPause() {
                if (this.texts.length === 0) {
                    this.showNotification('请先添加文本文件', 'warning');
                    return;
                }
                
                if (this.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            }

            // 播放
            play() {
                if (this.isPlaying) return;
                
                this.isPlaying = true;
                this.playBtn.innerHTML = '<i class="fa fa-pause"></i>';
                this.animateText();
            }

            // 暂停
            pause() {
                if (!this.isPlaying) return;
                
                this.isPlaying = false;
                this.playBtn.innerHTML = '<i class="fa fa-play"></i>';
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }

            // 文本滚动动画
            animateText() {
                if (!this.isPlaying) return;
                
                const textWidth = this.textElement.offsetWidth;
                const containerWidth = this.scrollContainer.offsetWidth;
                
                // 计算移动距离
                this.currentPosition -= this.baseSpeed * this.currentSpeed;
                
                // 更新文本位置
                this.textElement.style.transform = `translateY(-50%) translateX(${this.currentPosition}px)`;
                
                // 更新进度条
                const maxPosition = textWidth + containerWidth;
                const progress = Math.max(0, Math.min(100, 
                    100 * (Math.abs(this.currentPosition) / maxPosition)));
                this.progressBar.style.width = `${progress}%`;
                
                // 当文本完全移出左侧时，切换到下一个文本
                if (Math.abs(this.currentPosition) > textWidth + containerWidth) {
                    this.nextText();
                    this.displayCurrentText();
                    this.currentPosition = containerWidth;
                    this.progressBar.style.width = '0%';
                }
                
                this.animationId = requestAnimationFrame(() => this.animateText());
            }
            
            // 切换到下一个文本
            nextText() {
                if (this.currentFolder && this.currentFolder.files && this.currentFolder.files.length > 0) {
                    // 如果在文件夹内播放，按文件夹内顺序切换
                    this.currentTextIndex = (this.currentTextIndex + 1) % this.currentFolder.files.length;
                } else {
                    // 否则在所有文本中切换
                    this.currentTextIndex = (this.currentTextIndex + 1) % this.texts.length;
                }
            }

            // 显示当前文本
            displayCurrentText() {
                if (this.texts.length === 0) {
                    this.textElement.textContent = '请添加文本文件';
                    this.currentFileName.textContent = '无';
                    return;
                }
                
                let currentText;
                if (this.currentFolder && this.currentFolder.files && this.currentFolder.files.length > 0) {
                    currentText = this.currentFolder.files[this.currentTextIndex];
                } else {
                    currentText = this.texts[this.currentTextIndex];
                }
                
                this.textElement.textContent = currentText.content;
                this.textElement.style.color = this.textColor;
                
                // 设置字体大小
                switch(this.fontSize) {
                    case 'small':
                        this.textElement.style.fontSize = '1.8rem';
                        break;
                    case 'medium':
                        this.textElement.style.fontSize = '2.2rem';
                        break;
                    case 'large':
                        this.textElement.style.fontSize = '2.8rem';
                        break;
                }
                
                // 更新当前文件名显示
                if (currentText.folder) {
                    this.currentFileName.textContent = `${currentText.folder.name}/${currentText.name}`;
                } else {
                    this.currentFileName.textContent = currentText.name;
                }
            }

            // 显示文件列表模态框
            showFileListModal() {
                this.fileListModal.classList.add('visible');
                this.renderFileList();
            }

            // 隐藏文件列表模态框
            hideFileListModal() {
                this.fileListModal.classList.remove('visible');
            }

            // 显示字体大小模态框
            showFontSizeModal() {
                this.fontSizeModal.classList.add('visible');
            }

            // 隐藏字体大小模态框
            hideFontSizeModal() {
                this.fontSizeModal.classList.remove('visible');
            }

            // 显示背景设置模态框
            showBackgroundModal() {
                this.backgroundModal.classList.add('visible');
            }

            // 隐藏背景设置模态框
            hideBackgroundModal() {
                this.backgroundModal.classList.remove('visible');
            }

            // 显示数据爬取模态框
            showCrawlModal() {
                this.crawlModal.classList.add('visible');
                // 重置爬取状态
                this.resetCrawlProgress();
            }

            // 隐藏数据爬取模态框
            hideCrawlModal() {
                this.crawlModal.classList.remove('visible');
                if (this.isCrawling) {
                    this.isCrawling = false;
                    this.showNotification('爬取已取消', 'warning');
                }
            }

            // 显示书架模态框
            showBookShelfModal() {
                this.bookShelfModal.classList.add('visible');
                this.renderBookPanels();
                this.renderToolsGrid();
            }

            // 隐藏书架模态框
            hideBookShelfModal() {
                this.bookShelfModal.classList.remove('visible');
            }

            // 渲染文件列表
            renderFileList() {
                this.fileListContainer.innerHTML = '';
                
                if (this.texts.length === 0) {
                    this.noFilesMessage.style.display = 'block';
                    return;
                }
                
                this.noFilesMessage.style.display = 'none';
                
                // 分离文件夹和单独文件
                const folders = {};
                const files = [];
                
                this.texts.forEach(text => {
                    if (text.folder) {
                        if (!folders[text.folder.id]) {
                            folders[text.folder.id] = {
                                ...text.folder,
                                files: []
                            };
                        }
                        folders[text.folder.id].files.push(text);
                    } else {
                        files.push(text);
                    }
                });
                
                // 渲染单独文件
                files.forEach(file => {
                    const fileItem = this.createFileItem(file);
                    this.fileListContainer.appendChild(fileItem);
                });
                
                // 渲染文件夹
                Object.values(folders).forEach(folder => {
                    // 按文件名排序
                    folder.files.sort((a, b) => a.name.localeCompare(b.name));
                    
                    const folderElement = document.createElement('div');
                    folderElement.className = 'folder-item';
                    
                    const folderHeader = document.createElement('div');
                    folderHeader.className = 'folder-header';
                    
                    // 文件夹信息部分
                    const folderInfo = document.createElement('div');
                    folderInfo.className = 'folder-info';
                    folderInfo.innerHTML = `<i class="fa fa-folder-o"></i> ${folder.name} (${folder.files.length}个文件)`;
                    
                    // 文件夹删除按钮
                    const folderDeleteBtn = document.createElement('button');
                    folderDeleteBtn.className = 'folder-delete-btn';
                    folderDeleteBtn.innerHTML = '<i class="fa fa-trash"></i>';
                    folderDeleteBtn.title = '删除整个文件夹';
                    
                    // 添加删除文件夹事件
                    folderDeleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteFolder(folder);
                    });
                    
                    folderHeader.appendChild(folderInfo);
                    folderHeader.appendChild(folderDeleteBtn);
                    
                    const folderContent = document.createElement('div');
                    folderContent.className = 'folder-content';
                    folderContent.style.display = 'none';
                    
                    // 文件夹点击展开/折叠
                    folderHeader.addEventListener('click', (e) => {
                        if (e.target.closest('.folder-delete-btn')) return;
                        folderContent.style.display = folderContent.style.display === 'none' ? 'block' : 'none';
                        folderInfo.querySelector('i').className = folderContent.style.display === 'none' 
                            ? 'fa fa-folder-o' 
                            : 'fa fa-folder-open-o';
                    });
                    
                    // 添加文件夹内的文件
                    folder.files.forEach(file => {
                        const fileItem = this.createFileItem(file);
                        folderContent.appendChild(fileItem);
                    });
                    
                    // 添加播放整个文件夹按钮
                    const playFolderBtn = document.createElement('div');
                    playFolderBtn.className = 'file-item';
                    playFolderBtn.style.marginTop = '10px';
                    playFolderBtn.style.background = 'linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(129, 140, 248, 0.05))';
                    playFolderBtn.innerHTML = `
                        <div class="file-info">
                            <div class="file-name"><i class="fa fa-play-circle-o"></i> 播放整个文件夹</div>
                            <div class="file-count">按顺序播放所有文件</div>
                        </div>
                        <button class="file-action">选择</button>
                    `;
                    
                    playFolderBtn.querySelector('.file-action').addEventListener('click', () => {
                        this.currentFolder = folder;
                        this.currentTextIndex = 0;
                        this.displayCurrentText();
                        this.hideFileListModal();
                        this.showNotification(`已选择播放文件夹: ${folder.name}`, 'success');
                        this.play();
                    });
                    
                    folderContent.appendChild(playFolderBtn);
                    
                    folderElement.appendChild(folderHeader);
                    folderElement.appendChild(folderContent);
                    this.fileListContainer.appendChild(folderElement);
                });
            }
            
            // 创建文件列表项
            createFileItem(file) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-count">${file.content.length} 字符</div>
                    </div>
                    <button class="file-action">选择</button>
                `;
                
                fileItem.querySelector('.file-action').addEventListener('click', () => {
                    this.currentFolder = null;
                    this.currentTextIndex = this.texts.findIndex(t => t.id === file.id);
                    this.displayCurrentText();
                    this.hideFileListModal();
                    this.showNotification(`已选择: ${file.name}`, 'success');
                    this.play();
                });
                
                return fileItem;
            }

            // 删除文件夹方法
            deleteFolder(folder) {
                const folderName = folder.name;
                const fileCount = folder.files ? folder.files.length : 0;
                
                if (confirm(`确定要删除整个文件夹 "${folderName}" 吗？\n该文件夹包含 ${fileCount} 个文件，删除后无法恢复。`)) {
                    this.texts = this.texts.filter(text => {
                        if (text.folder && text.folder.id === folder.id) {
                            return false;
                        }
                        return true;
                    });
                    
                    if (this.currentFolder && this.currentFolder.id === folder.id) {
                        this.currentFolder = null;
                    }
                    
                    this.currentTextIndex = Math.min(this.currentTextIndex, this.texts.length - 1);
                    if (this.texts.length === 0) {
                        this.currentTextIndex = 0;
                        this.pause();
                    }
                    
                    this.saveToStorage();
                    this.updateUI();
                    this.displayCurrentText();
                    this.showNotification(`已删除文件夹 "${folderName}" (${fileCount}个文件)`, 'success');
                }
            }

            // ==================== 其他功能 ====================

            // 处理文件上传
            handleFileUpload(e) {
                const files = e.target.files;
                if (!files.length) return;
                
                let count = 0;
                Array.from(files).forEach(file => {
                    if (file.type.includes('text') || file.name.endsWith('.txt')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const content = event.target.result;
                            this.addText({
                                id: Date.now() + Math.random(),
                                name: file.name,
                                content: content,
                                added: new Date().getTime()
                            });
                            count++;
                        };
                        reader.readAsText(file);
                    }
                });
                
                this.fileInput.value = '';
                this.showNotification(`成功导入 ${count} 个文件`, 'success');
            }

            // 处理文件夹上传
            handleFolderUpload(e) {
                const files = e.target.files;
                if (!files.length) return;
                
                const folders = {};
                let count = 0;
                
                Array.from(files).forEach(file => {
                    if (file.type.includes('text') || file.name.endsWith('.txt')) {
                        const fullPath = file.webkitRelativePath;
                        const folderName = fullPath.split('/')[0];
                        const folderId = folderName + '_' + Date.now();
                        
                        if (!folders[folderId]) {
                            folders[folderId] = {
                                id: folderId,
                                name: folderName,
                                files: []
                            };
                        }
                        
                        const reader = new FileReader();
                        const currentFile = file;
                        reader.onload = (event) => {
                            const content = event.target.result;
                            this.addText({
                                id: Date.now() + Math.random() + currentFile.name,
                                name: currentFile.name,
                                content: content,
                                folder: folders[folderId],
                                added: new Date().getTime()
                            });
                            count++;
                        };
                        reader.readAsText(currentFile);
                    }
                });
                
                this.folderInput.value = '';
                this.showNotification(`成功导入 ${count} 个文件`, 'success');
            }

            // 添加文本
            addText(text) {
                this.texts.push(text);
                this.saveToStorage();
                this.updateUI();
                
                if (this.texts.length === 1) {
                    this.currentTextIndex = 0;
                    this.displayCurrentText();
                }
            }

            // 删除当前文本
            deleteCurrentText() {
                if (this.texts.length === 0) {
                    this.showNotification('没有可删除的文本', 'info');
                    return;
                }
                
                let currentText;
                if (this.currentFolder && this.currentFolder.files && this.currentFolder.files.length > 0) {
                    currentText = this.currentFolder.files[this.currentTextIndex];
                } else {
                    currentText = this.texts[this.currentTextIndex];
                }
                
                if (!currentText) {
                    this.showNotification('找不到当前文本', 'error');
                    return;
                }
                
                const shortText = currentText.content.length > 30 
                    ? currentText.content.substring(0, 30) + '...' 
                    : currentText.content;
                    
                if (confirm(`确定要删除当前文本 "${currentText.name}" 吗？\n内容预览: ${shortText}`)) {
                    this.texts = this.texts.filter(t => t.id !== currentText.id);
                    
                    if (this.currentFolder && this.currentFolder.files) {
                        this.currentFolder.files = this.currentFolder.files.filter(f => f.id !== currentText.id);
                        
                        if (this.currentFolder.files.length === 0) {
                            this.currentFolder = null;
                        }
                    }
                    
                    this.currentTextIndex = Math.min(this.currentTextIndex, this.texts.length - 1);
                    if (this.texts.length === 0) {
                        this.currentTextIndex = 0;
                        this.pause();
                    }
                    
                    this.saveToStorage();
                    this.updateUI();
                    this.displayCurrentText();
                    this.showNotification(`已删除文本 "${currentText.name}"`, 'success');
                }
            }

            // ==================== 数据爬取功能 ====================
            
            // 重置爬取进度
            resetCrawlProgress() {
                this.isCrawling = false;
                this.crawledData = [];
                this.crawlProgress.classList.remove('visible');
                this.crawlPreview.classList.remove('visible');
                this.progressFill.style.width = '0%';
                this.progressPercent.textContent = '0%';
                this.crawlCount.textContent = '0';
                this.timeRemaining.textContent = '--';
                this.startCrawlBtn.disabled = false;
                this.startCrawlBtn.innerHTML = '<i class="fa fa-download"></i> 开始爬取';
                this.saveCrawlBtn.disabled = true;
                this.crawlUrlInput.value = '';
            }
            
            // 开始爬取数据
            async startCrawling() {
                const url = this.crawlUrlInput.value.trim();
                
                if (!url) {
                    this.showNotification('请输入要爬取的网址', 'warning');
                    return;
                }
                
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    this.showNotification('请输入有效的网址（以http://或https://开头）', 'warning');
                    return;
                }
                
                this.isCrawling = true;
                this.crawledData = [];
                this.startCrawlBtn.disabled = true;
                this.startCrawlBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 爬取中...';
                this.crawlProgress.classList.add('visible');
                this.progressStatus.textContent = '正在爬取数据...';
                
                try {
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const targetUrl = encodeURIComponent(url);
                    
                    this.updateCrawlProgress(10, '正在连接到网站...');
                    await this.sleep(500);
                    
                    this.updateCrawlProgress(30, '正在下载网页内容...');
                    await this.sleep(500);
                    
                    const response = await fetch(`${proxyUrl}${targetUrl}`);
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    this.updateCrawlProgress(60, '正在解析网页内容...');
                    await this.sleep(500);
                    
                    const html = await response.text();
                    
                    this.updateCrawlProgress(80, '正在提取文本数据...');
                    await this.sleep(500);
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const elementsToRemove = doc.querySelectorAll('script, style, nav, footer, header, iframe, noscript');
                    elementsToRemove.forEach(el => el.remove());
                    
                    const bodyText = doc.body.textContent || '';
                    const sentences = this.splitIntoSentences(bodyText);
                    
                    this.updateCrawlProgress(90, '正在处理文本数据...');
                    await this.sleep(300);
                    
                    const cleanedSentences = sentences
                        .map(s => s.trim())
                        .filter(s => s.length > 10 && s.length < 500)
                        .slice(0, 50);
                    
                    this.crawledData = cleanedSentences;
                    
                    this.updateCrawlProgress(100, '爬取完成！');
                    
                    this.showCrawlPreview();
                    this.saveCrawlBtn.disabled = false;
                    
                    this.showNotification(`成功爬取 ${cleanedSentences.length} 条文本数据`, 'success');
                    
                } catch (error) {
                    console.error('爬取失败:', error);
                    this.showNotification(`爬取失败: ${error.message}`, 'error');
                    this.progressStatus.textContent = '爬取失败';
                } finally {
                    this.isCrawling = false;
                    this.startCrawlBtn.disabled = false;
                    this.startCrawlBtn.innerHTML = '<i class="fa fa-download"></i> 开始爬取';
                }
            }
            
            // 更新爬取进度
            updateCrawlProgress(percent, status) {
                this.progressFill.style.width = `${percent}%`;
                this.progressPercent.textContent = `${percent}%`;
                this.progressStatus.textContent = status;
                
                const estimatedTime = Math.round((100 - percent) / 2);
                this.timeRemaining.textContent = estimatedTime > 0 ? estimatedTime : '0';
                
                if (percent >= 80) {
                    const count = Math.round((percent - 80) / 20 * 50);
                    this.crawlCount.textContent = count > 0 ? count : '0';
                }
            }
            
            // 显示爬取预览
            showCrawlPreview() {
                this.crawlPreview.classList.add('visible');
                this.previewContent.innerHTML = '';
                
                if (this.crawledData.length === 0) {
                    this.previewContent.innerHTML = '<div class="sentence">未提取到有效文本数据</div>';
                    return;
                }
                
                const previewCount = Math.min(5, this.crawledData.length);
                for (let i = 0; i < previewCount; i++) {
                    const sentenceDiv = document.createElement('div');
                    sentenceDiv.className = 'sentence';
                    sentenceDiv.textContent = `${i + 1}. ${this.crawledData[i]}`;
                    this.previewContent.appendChild(sentenceDiv);
                }
                
                if (this.crawledData.length > previewCount) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'sentence';
                    moreDiv.style.fontStyle = 'italic';
                    moreDiv.textContent = `... 还有 ${this.crawledData.length - previewCount} 条文本未显示`;
                    this.previewContent.appendChild(moreDiv);
                }
            }
            
            // 保存爬取的数据
            saveCrawledData() {
                if (this.crawledData.length === 0) {
                    this.showNotification('没有可保存的数据', 'warning');
                    return;
                }
                
                const sourceName = this.crawlUrlInput.value || '网页数据';
                const folderName = `爬取数据_${new Date().toISOString().slice(0, 10)}`;
                const folderId = `crawled_${Date.now()}`;
                
                const folder = {
                    id: folderId,
                    name: folderName,
                    files: []
                };
                
                this.crawledData.forEach((content, index) => {
                    const textItem = {
                        id: `${folderId}_${index}`,
                        name: `${sourceName}_${index + 1}`,
                        content: content,
                        folder: folder,
                        added: new Date().getTime(),
                        source: 'web_crawl'
                    };
                    
                    this.texts.push(textItem);
                    folder.files.push(textItem);
                });
                
                this.saveToStorage();
                this.updateUI();
                this.hideCrawlModal();
                
                this.showNotification(`成功保存 ${this.crawledData.length} 条文本数据到文件夹: ${folderName}`, 'success');
            }
            
            // 加载预设数据源
            async loadPredefinedSource(source) {
                this.isCrawling = true;
                this.crawledData = [];
                this.startCrawlBtn.disabled = true;
                this.crawlProgress.classList.add('visible');
                this.progressStatus.textContent = '正在加载预设数据...';
                
                const predefinedData = {
                    news: [
                        "科技创新推动数字化转型，人工智能在各行业应用日益广泛。",
                        "全球经济复苏面临挑战，各国积极采取措施稳定市场。",
                        "环境保护成为全球共识，绿色能源发展迎来新机遇。",
                        "教育改革不断深化，在线学习模式受到广泛关注。",
                        "医疗卫生体系持续完善，公共卫生安全备受重视。",
                        "文化产业发展迅速，数字内容创作呈现多元化趋势。",
                        "交通出行更加便捷，智慧城市建设取得新进展。",
                        "农业现代化步伐加快，粮食安全保障能力提升。",
                        "金融服务不断创新，数字经济为金融业带来变革。",
                        "体育事业发展蓬勃，全民健身意识不断增强。"
                    ],
                    quotes: [
                        "成功不是最终目的，失败也不是致命伤，勇气继续前进才是最重要的。",
                        "人生就像骑自行车，为了保持平衡，你必须不断前进。",
                        "最困难的事情就是认识自己，最容易的事情就是给别人提建议。",
                        "时间是最公平的资源，每个人一天都是24小时，差别在于如何利用。",
                        "真正的智慧不在于知道一切，而在于知道自己不知道什么。",
                        "行动是治愈恐惧的良药，而犹豫拖延将不断滋养恐惧。",
                        "生活就像一盒巧克力，你永远不知道下一颗会是什么味道。",
                        "不要等待机会，而要创造机会，机会总是眷顾有准备的人。",
                        "相信自己能做到，你就已经成功了一半，自信是成功的第一秘诀。",
                        "昨天已经过去，明天尚未到来，只有今天是我们可以把握的礼物。"
                    ],
                    poetry: [
                        "春江潮水连海平，海上明月共潮生。滟滟随波千万里，何处春江无月明。",
                        "床前明月光，疑是地上霜。举头望明月，低头思故乡。",
                        "朝辞白帝彩云间，千里江陵一日还。两岸猿声啼不住，轻舟已过万重山。",
                        "横看成岭侧成峰，远近高低各不同。不识庐山真面目，只缘身在此山中。",
                        "明月几时有？把酒问青天。不知天上宫阙，今夕是何年。",
                        "君不见黄河之水天上来，奔流到海不复回。君不见高堂明镜悲白发，朝如青丝暮成雪。",
                        "故人西辞黄鹤楼，烟花三月下扬州。孤帆远影碧空尽，唯见长江天际流。",
                        "千山鸟飞绝，万径人踪灭。孤舟蓑笠翁，独钓寒江雪。",
                        "红豆生南国，春来发几枝。愿君多采撷，此物最相思。",
                        "大漠孤烟直，长河落日圆。萧关逢候骑，都护在燕然。"
                    ],
                    jokes: [
                        "为什么程序员总是分不清万圣节和圣诞节？因为 Oct 31 == Dec 25。",
                        "我问电脑：你为什么要叫电脑？电脑回答：因为我是脑，你用电。",
                        "为什么数学书总是很悲伤？因为它有太多问题要解决。",
                        "为什么手机不会吃饭？因为它已经饱了（饱了电）。",
                        "为什么自行车不能自己站起来？因为它太累了（两轮）。",
                        "为什么海水是咸的？因为鱼在海里流了太多眼泪。",
                        "为什么猫从树上掉下来不会受伤？因为它总是用脚着地。",
                        "为什么西瓜很大？因为它不想被当成葡萄。",
                        "为什么时钟很害羞？因为它总是手捂着脸。",
                        "为什么书很聪明？因为它有很多页（智慧）。"
                    ],
                    knowledge: [
                        "太阳是太阳系的中心天体，占太阳系总质量的99.86%。",
                        "水是地球上唯一在自然条件下以三种状态存在的物质。",
                        "人类的大脑由约860亿个神经元组成，每个神经元可以形成数千个连接。",
                        "光在真空中的传播速度是每秒299,792,458米，这是宇宙中最快的速度。",
                        "地球的自转速度在逐渐减慢，每天的长度每百年增加约1.8毫秒。",
                        "DNA是脱氧核糖核酸的缩写，它携带了生物体的遗传信息。",
                        "金字塔是古代埃及人建造的陵墓，最大的是胡夫金字塔。",
                        "亚马逊雨林被称为地球之肺，生产地球上20%的氧气。",
                        "大熊猫每天要花12-16小时吃东西，主要食物是竹子。",
                        "珠穆朗玛峰是世界最高峰，海拔8848.86米。"
                    ]
                };
                
                try {
                    for (let i = 0; i <= 100; i += 10) {
                        this.updateCrawlProgress(i, `正在加载${this.getSourceName(source)}数据...`);
                        await this.sleep(100);
                    }
                    
                    this.crawledData = predefinedData[source] || [];
                    this.updateCrawlProgress(100, '数据加载完成！');
                    
                    this.showCrawlPreview();
                    this.saveCrawlBtn.disabled = false;
                    
                    this.showNotification(`成功加载 ${this.crawledData.length} 条${this.getSourceName(source)}数据`, 'success');
                    
                } catch (error) {
                    console.error('加载预设数据失败:', error);
                    this.showNotification('加载预设数据失败', 'error');
                } finally {
                    this.isCrawling = false;
                    this.startCrawlBtn.disabled = false;
                }
            }
            
            // 获取数据源名称
            getSourceName(source) {
                const names = {
                    news: '新闻资讯',
                    quotes: '名人名言',
                    poetry: '诗词歌赋',
                    jokes: '笑话段子',
                    knowledge: '知识科普',
                    custom: '自定义'
                };
                return names[source] || source;
            }
            
            // 将文本分割成句子
            splitIntoSentences(text) {
                const sentenceRegex = /[^.!?。！？]+[.!?。！？]/g;
                const matches = text.match(sentenceRegex);
                
                if (!matches) {
                    return [text];
                }
                
                return matches.map(s => s.trim()).filter(s => s.length > 0);
            }
            
            // 延时函数
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // 设置播放速度
            setSpeed(speed) {
                this.currentSpeed = speed;
                
                document.querySelectorAll('.speed-option').forEach(option => {
                    if (parseFloat(option.dataset.speed) === speed) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
                
                this.saveToStorage();
                this.showNotification(`播放速度已设置为 ${speed}x`, 'info');
            }

            // 设置文本颜色
            setTextColor(color) {
                this.textColor = color;
                this.textElement.style.color = color;
                
                document.querySelectorAll('.color-option').forEach(option => {
                    if (option.dataset.color === color) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
                
                this.saveToStorage();
                this.showNotification('文本颜色已更新', 'info');
            }

            // 设置字体大小
            setFontSize(size) {
                this.fontSize = size;
                
                document.querySelectorAll('.font-size-option').forEach(option => {
                    if (option.dataset.size === size) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
                
                this.displayCurrentText();
                this.saveToStorage();
                this.showNotification(`字体大小已设置为 ${size === 'small' ? '小号' : size === 'medium' ? '中号' : '大号'}`, 'info');
            }

            // 设置背景颜色
            setBackgroundColor(preset) {
                this.backgroundPreset = preset;
                
                const body = document.body;
                switch(preset) {
                    case 'default':
                        body.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)';
                        break;
                    case 'blue':
                        body.style.background = 'linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)';
                        break;
                    case 'purple':
                        body.style.background = 'linear-gradient(135deg, #f0abfc 0%, #c77dff 100%)';
                        break;
                    case 'green':
                        body.style.background = 'linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)';
                        break;
                    case 'red':
                        body.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
                        break;
                    case 'dark':
                        body.style.background = 'linear-gradient(135deg, #1e293b 0%, #334155 100%)';
                        break;
                }
                
                body.style.opacity = this.backgroundOpacity;
                
                document.querySelectorAll('.background-option').forEach(option => {
                    if (option.dataset.bg === preset) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
                
                this.saveToStorage();
                this.showNotification('背景颜色已更新', 'info');
            }

            // 设置背景透明度
            setBackgroundOpacity(opacity) {
                this.backgroundOpacity = opacity;
                document.body.style.opacity = opacity;
                this.opacityValue.textContent = `${Math.round(opacity * 100)}%`;
                this.backgroundOpacityInput.value = opacity;
                this.saveToStorage();
                this.showNotification(`背景透明度已设置为 ${Math.round(opacity * 100)}%`, 'info');
            }

            // 显示通知
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `<i class="fa fa-${this.getNotificationIcon(type)}"></i> ${message}`;
                
                this.notificationArea.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }
            
            // 获取通知图标
            getNotificationIcon(type) {
                switch(type) {
                    case 'success': return 'check-circle';
                    case 'error': return 'exclamation-circle';
                    case 'warning': return 'exclamation-triangle';
                    default: return 'info-circle';
                }
            }

            // 更新UI
            updateUI() {
                this.renderFileList();
            }

            // 保存到本地存储
            saveToStorage() {
                try {
                    const data = {
                        texts: this.texts,
                        currentTextIndex: this.currentTextIndex,
                        currentSpeed: this.currentSpeed,
                        textColor: this.textColor,
                        fontSize: this.fontSize,
                        backgroundPreset: this.backgroundPreset,
                        backgroundOpacity: this.backgroundOpacity,
                        currentFolder: this.currentFolder ? this.currentFolder.id : null
                    };
                    localStorage.setItem('textCarouselData', JSON.stringify(data));
                } catch (e) {
                    console.error('保存数据失败:', e);
                    this.showNotification('保存设置失败', 'error');
                }
            }

            // 从本地存储加载
            loadFromStorage() {
                try {
                    const data = localStorage.getItem('textCarouselData');
                    if (data) {
                        const parsed = JSON.parse(data);
                        this.texts = parsed.texts || [];
                        this.currentTextIndex = parsed.currentTextIndex || 0;
                        this.currentSpeed = parsed.currentSpeed || 1;
                        this.textColor = parsed.textColor || '#1e293b';
                        this.fontSize = parsed.fontSize || 'medium';
                        this.backgroundPreset = parsed.backgroundPreset || 'default';
                        this.backgroundOpacity = parsed.backgroundOpacity !== undefined ? parsed.backgroundOpacity : 1;
                        
                        this.setBackgroundColor(this.backgroundPreset);
                        this.setBackgroundOpacity(this.backgroundOpacity);
                        
                        document.querySelectorAll('.speed-option').forEach(option => {
                            if (parseFloat(option.dataset.speed) === this.currentSpeed) {
                                option.classList.add('active');
                            } else {
                                option.classList.remove('active');
                            }
                        });
                        
                        document.querySelectorAll('.color-option').forEach(option => {
                            if (option.dataset.color === this.textColor) {
                                option.classList.add('active');
                            } else {
                                option.classList.remove('active');
                            }
                        });
                        
                        document.querySelectorAll('.font-size-option').forEach(option => {
                            if (option.dataset.size === this.fontSize) {
                                option.classList.add('active');
                            } else {
                                option.classList.remove('active');
                            }
                        });
                    }
                    
                    this.loadBooksFromStorage();
                    this.loadToolsFromStorage();
                    
                } catch (e) {
                    console.error('加载数据失败:', e);
                    this.showNotification('加载设置失败', 'error');
                }
            }

            // 添加示例文本
            addExampleTexts() {
                if (this.texts.length === 0) {
                    this.addText({
                        id: 'example-1',
                        name: '示例文本',
                        content: '支持多种预设数据源：新闻资讯、名人名言、诗词歌赋、笑话段子和知识科普。',
                        added: new Date().getTime()
                    });
                }
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            const app = new TextCarousel();
        });
    </script>
</body>
</html>